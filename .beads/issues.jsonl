{"id":"beadhub-60i8","title":"Route bdh chat to global orchestrator via bridge relay","description":"## Problem\n\nThe global orchestrator (K8s BLPOP dispatcher) can't receive bdh chat messages from developer agents. When a developer sends `bdh :aweb chat send-and-wait orchestrator 'question'`, the message goes to BeadHub DB and Redis pub/sub, but nothing pushes it to `orchestrator:inbox`. The developer's send-and-wait times out.\n\n## Solution\n\n1. **Bridge relay**: discord-bridge detects chat events targeting 'orchestrator' and pushes them to `orchestrator:inbox`\n2. **Stateless chat handling**: Dispatcher runs fresh `claude -p` for each chat (not --resume). Context recovered from bdh (chat history, status, bead details)\n3. **Role enforcement**: Orchestrator always uses coordinator role via bdh :init; spawned agents use roles defined in bdh policy\n4. **Project context**: Bridge includes repo info from BeadHub API so orchestrator can clone and set up project context\n5. **Cleanup**: Delete broken orchestrator-listener Deployment\n\n## Repos touched\n- hq-beadhub: discord-bridge changes (redis-listener, types, config, beadhub-client)\n- homelab-k8s: orchestrator.yaml dispatcher + orchestrator-docs.yaml CLAUDE.md\n\n## Plan file\nSee /home/woodson/.claude/plans/purring-hopping-hanrahan.md","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-27T22:44:54.320192551-05:00","created_by":"woodson","updated_at":"2026-02-27T22:57:12.377324135-05:00","closed_at":"2026-02-27T22:57:12.377324135-05:00","close_reason":"Implemented chat-to-orchestrator relay in discord-bridge, added processChatMessage handler in dispatcher, updated orchestrator docs with chat handling/role enforcement/project querying, fixed worker-template role placeholder, deleted broken orchestrator-listener"}
{"id":"beadhub-fj7o","title":"Update orchestrator system prompt for project context switching via bdh","description":"The orchestrator should be able to bdh :init into any project and inherit full chat history. Update the system prompt to: (1) explain project switching, (2) guide brainstorm-to-project transitions, (3) clarify when to use ephemeral sessions vs bdh-backed persistence. Also update known projects list as new projects are added.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-26T23:52:03.008758937-05:00","created_by":"woodson","updated_at":"2026-02-27T12:40:17.779426863-05:00","closed_at":"2026-02-27T12:40:17.779426863-05:00","close_reason":"Completed by hand \u2014 system prompt already updated in homelab-k8s. Orchestrator incorrectly rewrote its own Deployment spec when attempting this task."}
{"id":"beadhub-hr46","title":"Add SSH access to orchestrator pod for ADB/emulator on desktop","description":"The orchestrator needs SSH access to the human's desktop machine to run ADB commands for headless Android builds. Requires: SSH key pair, network route from Pi 5 to desktop, ADB CLI in agent image. Enables: build -> screenshot verify -> loop workflow.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-26T23:51:43.518566553-05:00","created_by":"woodson","updated_at":"2026-02-26T23:51:43.518566553-05:00"}
{"id":"beadhub-jbnm","title":"CI/CD: Auto-build and push Docker images on merge","description":"Currently building and pushing Docker images is manual: pull changes, run docker buildx, push to ghcr.io, then restart pods. This needs automation.\n\nImages:\n- ghcr.io/woody88/discord-bridge:main (from discord-bridge/)\n- ghcr.io/woody88/beadhub:main (from ./)\n- ghcr.io/woody88/claude-agent:latest (from agent-image/)\n\nRepo: Woody88/hq-beadhub\n\nRequirements:\n- GitHub Actions workflow that triggers on merge to main\n- Detect which Dockerfile contexts changed and only build those\n- Build for linux/arm64 (Pi 5 target)\n- Push to ghcr.io\n- Optionally trigger pod restart on the cluster (webhook or ArgoCD image updater)\n\nConsiderations:\n- arm64 builds are slow on GitHub Actions (QEMU emulation) \u2014 may need self-hosted runner or buildx cloud\n- ArgoCD Image Updater could watch ghcr.io tags and auto-update deployments","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-27T14:49:05.623426237-05:00","created_by":"woodson","updated_at":"2026-02-27T14:49:05.623426237-05:00"}
{"id":"beadhub-jqhe","title":"Remove sitelink-orchestrator CronJob","description":"The general orchestrator Deployment replaces the project-scoped sitelink-orchestrator CronJob. Remove sitelink-orchestrator.yaml from homelab-k8s/manifests/platform/beadhub/ and update kustomization.yaml. The general orchestrator can bdh :init into any project on demand.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-26T23:51:32.526767283-05:00","created_by":"woodson","updated_at":"2026-03-01T07:21:42.735911+00:00","closed_at":"2026-03-01T07:21:42.735911+00:00","close_reason":"Verified removed from cluster \u2014 no sitelink resources found in any namespace."}
{"id":"beadhub-m5x7","title":"Rebuild agent image with ADB CLI","description":"Add ADB (Android Debug Bridge) CLI to the claude-agent Docker image (ghcr.io/woody88/claude-agent:latest). Required for headless Android builds and screenshot verification loop. Rebuild and push for arm64.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-26T23:51:55.391077532-05:00","created_by":"woodson","updated_at":"2026-02-26T23:51:55.391077532-05:00"}
{"id":"beadhub-sd6p","title":"Add Discord attachment support to orchestrator\u2192bridge pipeline","description":"Enable the orchestrator agent to send file attachments (screenshots, audio, etc.) to Discord threads.\n\n## Repo\nClone Woody88/hq-beadhub \u2014 the discord-bridge source is in discord-bridge/src/.\n\n## Current State\nThe pipeline is text-only: Claude stdout \u2192 Redis outbox (JSON with response string) \u2192 bridge posts text via Discord webhook.\n\n## Required Changes\n\n1. **Outbox message format** (types.ts): Add optional `attachments` field to OrchestratorOutboxMessage:\n   - Each attachment: `{ filename: string, path: string }` (file path on orchestrator pod)\n   - Alternative: base64-encoded content if files can't be shared via filesystem\n\n2. **Agent file convention**: Claude saves files to a known directory (e.g. /tmp/discord-attachments/) and the dispatcher includes them in the outbox message. The dispatcher script in the orchestrator Deployment manifest (homelab-k8s repo) needs to scan for attachments after Claude exits.\n\n3. **Bridge relay** (orchestrator-relay.ts): When outbox message has attachments, use `webhook.send({ content, files: [...] })` instead of plain text. Discord.js supports AttachmentBuilder for file uploads.\n\n4. **Cross-pod file transfer**: Since orchestrator and bridge run in different pods, files can't be shared via filesystem. Options:\n   - Base64-encode files in the Redis message (simplest, works for <8MB)\n   - Shared PVC mount (more complex)\n   - Temporary presigned URL (overkill)\n\n## HIL (Human-in-the-Loop)\nAfter implementation, the worker MUST ask the human to verify in Discord that attachments display correctly before closing this bead. Send a test screenshot and a test text file to confirm.\n\n## Acceptance Criteria\n- [ ] Orchestrator can send image files (png/jpg) to Discord threads\n- [ ] Orchestrator can send text/log files to Discord threads  \n- [ ] Messages with attachments also include text content\n- [ ] Files >8MB are gracefully rejected with an error message\n- [ ] Human confirms attachments render correctly in Discord\n## Status Note (2026-03-01)\n\nCode is implemented but attachment delivery to Discord threads is broken.\n\n**Bug:** Webhook file uploads to threads fail with Discord error 10003 (Unknown Channel).\n- Text-only messages post to threads successfully via webhook\n- When files are included, Discord rejects the request with \"Unknown Channel\"\n- Root cause: Discord enforces stricter channel validation for multipart (file) webhook requests vs JSON text requests\n- Affected path: sendAsAgent() in discord-sender.ts -> webhook.send({ files, threadId })\n\n**Fix needed:** Send files via bot client directly rather than via webhook when targeting threads.\n## Status Note (2026-03-01)\n\nCode is implemented but attachment delivery to Discord threads is broken.\n\n**Bug:** Webhook file uploads to threads fail with Discord error 10003 (Unknown Channel).\n- Text-only messages post to threads successfully via webhook\n- When files are included, Discord rejects the request with \"Unknown Channel\"\n- Root cause: Discord enforces stricter channel validation for multipart (file) webhook requests vs JSON text requests\n- Affected path: sendAsAgent() in discord-sender.ts -> webhook.send({ files, threadId })\n\n**Fix needed:** Send files via bot client directly rather than via webhook when targeting threads.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-27T01:57:20.299825142-05:00","created_by":"woodson","updated_at":"2026-03-01T07:21:42.735911+00:00"}
{"id":"beadhub-thh0","title":"Add Cloudflare access to orchestrator pod","description":"Give the orchestrator access to Cloudflare for tunnel management and DNS operations. Requires adding Cloudflare API token as a K8s secret and mounting it in the orchestrator Deployment.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-26T23:51:49.342165301-05:00","created_by":"woodson","updated_at":"2026-02-26T23:51:49.342165301-05:00"}
